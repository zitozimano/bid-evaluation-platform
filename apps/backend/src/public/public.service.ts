import { Injectable } from "@nestjs/common";
import { PrismaService } from "../prisma/prisma.service";
import PDFDocument = require("pdfkit");

@Injectable()
export class PublicService {
  constructor(private readonly prisma: PrismaService) {}

  async listPublishedTenders() {
    const tenders = await this.prisma.tender.findMany({
      where: { category: "PUBLISHED" }, // or use a dedicated flag
      orderBy: { createdAt: "desc" },
      include: {
        evaluationResults: {
          include: { bidder: true },
        },
      },
    });

    return tenders.map((t) => ({
      id: t.id,
      number: t.number,
      description: t.description,
      publishedAt: t.updatedAt,
      topBidder:
        t.evaluationResults
          .slice()
          .sort((a, b) => b.totalScore - a.totalScore)[0]?.bidder?.name ??
        null,
    }));
  }

  async generateTenderAwardPdf(tenderNumber: string): Promise<Buffer> {
    const tender = await this.prisma.tender.findFirst({
      where: { number: tenderNumber },
      include: {
        evaluationResults: {
          include: { bidder: true },
        },
      },
    });

    if (!tender) {
      throw new Error("Tender not found");
    }

    const doc = new PDFDocument({ margin: 50 });
    const chunks: Buffer[] = [];

    return await new Promise<Buffer>((resolve, reject) => {
      doc.on("data", (c) => chunks.push(c));
      doc.on("end", () => resolve(Buffer.concat(chunks)));
      doc.on("error", reject);

      doc.fontSize(18).text("Tender Award Notice", { align: "center" });
      doc.moveDown();

      doc.fontSize(12).text(`Tender: ${tender.number}`);
      doc.text(`Description: ${tender.description}`);
      doc.text(`Published: ${tender.updatedAt.toISOString()}`);
      doc.moveDown();

      doc.fontSize(14).text("Awarded Bidder", { underline: true });
      const sorted = tender.evaluationResults
        .slice()
        .sort((a, b) => b.totalScore - a.totalScore);
      const winner = sorted[0];

      if (winner) {
        doc.fontSize(12).text(`Bidder: ${winner.bidder.name}`);
        doc.text(`Total Score: ${winner.totalScore}`);
        doc.text(`Price: ${winner.price}`);
      } else {
        doc.fontSize(12).text("No evaluation results available.");
      }

      doc.moveDown();
      doc.fontSize(10).text("Generated by Bid Evaluation Platform");

      doc.end();
    });
  }
}
