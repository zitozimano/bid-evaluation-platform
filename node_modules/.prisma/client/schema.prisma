generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String          @id @default(uuid())
  code      String          @unique
  name      String
  active    Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  branding  TenantBranding?
  tenders   Tender[]
  users     User[]
}

model TenantBranding {
  id             String   @id @default(uuid())
  tenantId       String   @unique
  primaryColor   String?
  secondaryColor String?
  logoUrl        String?
  publicName     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
}

model User {
  id             String                @id @default(uuid())
  email          String                @unique
  name           String?
  role           String // primary role label (SCM, CFO, ADMIN, AUDIT, etc.)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  password       String
  tenantId       String?
  analyticsLogs  AnalyticsAccessLog[]
  scmAssignments ScmTenderAssignment[]
  tenant         Tenant?               @relation(fields: [tenantId], references: [id])

  // notifications & rules
  notifications     Notification[]
  notificationRules NotificationRule[] @relation("RuleOwner")

  @@index([tenantId])
}

model ScmTenderAssignment {
  id        String   @id @default(uuid())
  userId    String
  tenderId  String
  createdAt DateTime @default(now())
  tender    Tender   @relation(fields: [tenderId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, tenderId])
  @@index([tenderId])
}

model Tender {
  id                String                @id @default(uuid())
  number            String
  description       String
  category          String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  tenantId          String?
  bidders           Bidder[]
  evaluationConfig  EvaluationConfig?
  documents         EvaluationDocument[]
  evaluationResults EvaluationResult[]
  signatures        EvaluationSignature[]
  scmAssignments    ScmTenderAssignment[]
  tenant            Tenant?               @relation(fields: [tenantId], references: [id])

  // new relations
  timelineEvents      TenderTimelineEvent[]
  insights            TenderInsights?
  heatmap             TenderHeatmap?
  complianceDashboard TenderComplianceDashboard?

  @@index([tenantId])
}

model Bidder {
  id                     String                 @id @default(uuid())
  tenderId               String
  name                   String
  price                  Float?
  disqualified           Boolean                @default(false)
  disqualificationReason String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  bbbee                  Bbbee?
  tender                 Tender                 @relation(fields: [tenderId], references: [id])
  technicalScores        BidderCriterionScore[]
  evaluationResults      EvaluationResult[]
  evidence               Evidence[]

  // new relation
  intelligence BidderIntelligence?
  riskProfile  BidderRiskProfile?

  @@index([tenderId])
}

model Bbbee {
  id        String    @id @default(uuid())
  bidderId  String    @unique
  level     Int?
  expiry    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  bidder    Bidder    @relation(fields: [bidderId], references: [id])
}

model Evidence {
  id        String   @id @default(uuid())
  bidderId  String
  type      String
  metadata  Json?
  url       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bidder    Bidder   @relation(fields: [bidderId], references: [id])

  @@index([bidderId])
}

model EvaluationConfig {
  id                String   @id @default(uuid())
  tenderId          String   @unique
  priceWeight       Int
  bbbeeWeight       Int
  functionalityPass Int
  functionalityMax  Int
  criteria          Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tender            Tender   @relation(fields: [tenderId], references: [id])
}

model BidderCriterionScore {
  id            String   @id @default(uuid())
  bidderId      String
  criterionCode String
  rawScore      Float
  scaleMax      Float
  weight        Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  bidder        Bidder   @relation(fields: [bidderId], references: [id])

  @@index([bidderId])
}

model EvaluationResult {
  id                 String                @id @default(uuid())
  tenderId           String
  bidderId           String
  functionalityScore Float
  qualifies          Boolean
  price              Float
  priceScore         Float
  bbbeeLevel         Int?
  bbbeePoints        Float
  totalScore         Float
  riskScore          Float?
  complianceRate     Float?
  exceptionsCount    Int                   @default(0)
  slaBreached        Boolean               @default(false)
  currentStage       String?
  createdAt          DateTime              @default(now())
  hash               String                @unique
  compliance         ComplianceItem[]
  exceptions         EvaluationException[]
  bidder             Bidder                @relation(fields: [bidderId], references: [id])
  tender             Tender                @relation(fields: [tenderId], references: [id])
  workflowLogs       WorkflowLog[]

  @@index([tenderId])
  @@index([bidderId])
}

model WorkflowLog {
  id                 String   @id @default(uuid())
  evaluationResultId String
  stage              String
  daysSpent          Float
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt

  evaluationResult EvaluationResult @relation(fields: [evaluationResultId], references: [id])

  @@index([evaluationResultId])
  @@index([stage])
}

model Circular {
  id        String           @id @default(uuid())
  label     String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  rules     ComplianceRule[]
}

model ComplianceRule {
  id          String           @id @default(uuid())
  circularId  String
  code        String
  label       String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  items       ComplianceItem[]
  circular    Circular         @relation(fields: [circularId], references: [id])

  @@index([circularId])
}

model ComplianceItem {
  id                 String           @id @default(uuid())
  evaluationResultId String
  ruleId             String
  compliant          Boolean
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  evaluationResult   EvaluationResult @relation(fields: [evaluationResultId], references: [id])
  rule               ComplianceRule   @relation(fields: [ruleId], references: [id])

  @@index([evaluationResultId])
  @@index([ruleId])
}

model EvaluationException {
  id                 String           @id @default(uuid())
  evaluationResultId String
  type               String
  reason             String
  approved           Boolean?
  approvedBy         String?
  approvedAt         DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  evaluationResult   EvaluationResult @relation(fields: [evaluationResultId], references: [id])

  @@index([evaluationResultId])
}

model EvaluationSignature {
  id        String   @id @default(uuid())
  tenderId  String
  role      String
  name      String
  signature String?
  comment   String?
  signedAt  DateTime @default(now())
  tender    Tender   @relation(fields: [tenderId], references: [id])

  @@unique([tenderId, role])
  @@index([tenderId])
}

model EvaluationDocument {
  id        String   @id @default(uuid())
  tenderId  String
  runNumber Int
  fileUrl   String
  hash      String
  createdAt DateTime @default(now())
  tender    Tender   @relation(fields: [tenderId], references: [id])

  @@unique([tenderId, runNumber])
  @@index([tenderId])
}

model AnalyticsAccessLog {
  id        String   @id @default(uuid())
  userId    String
  role      String
  endpoint  String
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([endpoint])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  message   String
  createdAt DateTime @default(now())

  @@index([userId])
}

model NotificationRule {
  id      String  @id @default(uuid())
  trigger String
  role    String
  enabled Boolean @default(true)
  ownerId String?
  owner   User?   @relation("RuleOwner", fields: [ownerId], references: [id])

  @@unique([trigger, role], name: "trigger_role")
  @@index([trigger])
  @@index([role])
}

model TenderTimelineEvent {
  id        String   @id @default(uuid())
  tenderId  String
  tender    Tender   @relation(fields: [tenderId], references: [id])
  type      String
  label     String
  createdAt DateTime @default(now())

  @@index([tenderId])
  @@index([type])
}

model TenderInsights {
  tenderId String @id
  tender   Tender @relation(fields: [tenderId], references: [id])
  payload  Json
}

model TenderHeatmap {
  tenderId String @id
  tender   Tender @relation(fields: [tenderId], references: [id])
  cells    Json // [{ bidderName, ruleCode, compliant }]
}

model BidderIntelligence {
  bidderId String @id
  bidder   Bidder @relation(fields: [bidderId], references: [id])
  timeline Json // [{ tenderNumber, totalScore, price, awarded, createdAt }]
}

model BidderRiskProfile {
  bidderId String @id
  bidder   Bidder @relation(fields: [bidderId], references: [id])
  profile  Json // risk dimensions
}

model TenderComplianceDashboard {
  tenderId String @id
  tender   Tender @relation(fields: [tenderId], references: [id])
  payload  Json
}
